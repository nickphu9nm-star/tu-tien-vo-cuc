import React, { useState, useEffect, useCallback, useRef, useMemo } from 'react';
import { Player, LogEntry, TabType, SecretRealm, Item, ItemType, InventoryItem, ItemRarity, EquipSlot, PlayerStats, MarketListing, WorldBoss, LeaderboardEntry, ChatMessage, Fighter, AuthStatus, ServerState } from './types';
import { MAJOR_REALMS, MINOR_REALMS, INITIAL_PLAYER_STATE, TICK_RATE_MS, SECRET_REALMS, POSSIBLE_ITEMS, generateEquipment, MOCK_LEADERBOARD, MOCK_MARKET, WORLD_BOSSES, DISMANTLE_RATES, MOCK_WORLD_CHAT, calculateEnhanceChance, calculateEnhanceCost } from './constants';
import CultivationCanvas from './components/CultivationCanvas';
import BossCanvas from './components/BossCanvas';
import ProgressBar from './components/ProgressBar';
import ItemDetailModal from './components/ItemDetailModal';
import SecretRealmModal from './components/SecretRealmModal';
import EnhancementRatesModal from './components/EnhancementRatesModal';
import PlayerInspectionModal from './components/PlayerInspectionModal';
import EquipIcon from './components/EquipIcon';
import CombatModal from './components/CombatModal';
import CanvasIcon, { IconType } from './components/CanvasIcon';

const getRarityColor = (rarity: ItemRarity) => { switch (rarity) { case ItemRarity.RED: return 'text-red-500 border-red-500 shadow-[0_0_10px_rgba(239,68,68,0.5)]'; case ItemRarity.ORANGE: return 'text-orange-500 border-orange-500'; case ItemRarity.GOLD: return 'text-yellow-400 font-bold border-yellow-400'; case ItemRarity.PURPLE: return 'text-purple-400 border-purple-400'; case ItemRarity.BLUE: return 'text-blue-400 border-blue-400'; case ItemRarity.GREEN: return 'text-green-400 border-green-400'; default: return 'text-gray-400 border-gray-600'; } };
const getRarityHex = (rarity: ItemRarity) => { switch(rarity) { case ItemRarity.RED: return '#ef4444'; case ItemRarity.ORANGE: return '#f97316'; case ItemRarity.GOLD: return '#facc15'; case ItemRarity.PURPLE: return '#c084fc'; case ItemRarity.BLUE: return '#60a5fa'; case ItemRarity.GREEN: return '#4ade80'; default: return '#9ca3af'; } };

const StatRow = ({ label, value, subLabel, icon }: { label: string, value: string | number, subLabel?: string, icon?: React.ReactNode }) => (
  <div className="flex justify-between items-center py-2 border-b border-void-700 last:border-0 text-sm hover:bg-void-700/30 transition-colors">
    <div className="flex items-center gap-2 text-gray-400 font-medium">{icon}<span>{label}</span></div>
    <div className="text-right"><span className="font-mono font-bold text-qi-400 text-base">{value}</span>{subLabel && <span className="text-xs text-gray-600 ml-1">{subLabel}</span>}</div>
  </div>
);

interface EquipmentSlotProps { slot: EquipSlot; player: Player; selectedEnhanceSlot: EquipSlot | null; activeTab: TabType; smithingMode: 'enhance' | 'dismantle'; onClick: (slot: EquipSlot) => void; }
const EquipmentSlotComponent: React.FC<EquipmentSlotProps> = ({ slot, player, selectedEnhanceSlot, activeTab, smithingMode, onClick }) => {
    const equippedItem = player.equipment[slot];
    const isSelected = selectedEnhanceSlot === slot && activeTab === TabType.SMITHING && smithingMode === 'enhance';
    const hexColor = equippedItem ? getRarityHex(equippedItem.rarity) : "#4b5563"; 
    return (
      <div onClick={() => onClick(slot)} className={`w-12 h-12 rounded border-2 flex items-center justify-center cursor-pointer relative transition-all ${isSelected ? 'border-gold-400 bg-void-700 scale-110 shadow-lg shadow-gold-500/20' : 'border-void-600 bg-void-800 hover:border-gray-500'} ${equippedItem ? getRarityColor(equippedItem.rarity) : 'text-void-600'}`}>
        <div className="flex flex-col items-center justify-center w-full h-full p-2"><EquipIcon slot={slot} color={hexColor} className="w-full h-full"/>{equippedItem && equippedItem.enhancementLevel! > 0 && (<span className="absolute -top-2 -right-2 bg-red-600 text-white text-[10px] px-1.5 py-0.5 rounded-full font-bold shadow-sm">+{equippedItem.enhancementLevel}</span>)}</div>
      </div>
    );
};

const SERVER_KEY_BOSS = 'ttvc_server_boss'; const SERVER_KEY_MARKET = 'ttvc_server_market'; const SERVER_KEY_CHAT = 'ttvc_server_chat'; const USER_KEY_PREFIX = 'ttvc_user_';

const App: React.FC = () => {
  const [authStatus, setAuthStatus] = useState<AuthStatus>(AuthStatus.CHECKING);
  const [isRegisterMode, setIsRegisterMode] = useState(false);
  const [usernameInput, setUsernameInput] = useState(''); const [passwordInput, setPasswordInput] = useState(''); 
  const [serverLatency, setServerLatency] = useState(0); const [loginError, setLoginError] = useState(''); const [loginSuccess, setLoginSuccess] = useState('');
  
  const [player, setPlayer] = useState<Player>(INITIAL_PLAYER_STATE);
  const [logs, setLogs] = useState<LogEntry[]>([]);
  const [activeTab, setActiveTab] = useState<TabType>(TabType.SMITHING);
  const [activeLogTab, setActiveLogTab] = useState<'personal' | 'world'>('personal');
  const [chatInputValue, setChatInputValue] = useState("");
  
  const [exploringRealmId, setExploringRealmId] = useState<number | null>(null); const [explorationTimer, setExplorationTimer] = useState<number>(0); 
  const [previewRealm, setPreviewRealm] = useState<SecretRealm | null>(null);

  const [bosses, setBosses] = useState<WorldBoss[]>(WORLD_BOSSES);
  const [marketListings, setMarketListings] = useState<MarketListing[]>(MOCK_MARKET);
  const [worldChatMessages, setWorldChatMessages] = useState<ChatMessage[]>(MOCK_WORLD_CHAT);
  const [leaderboard, setLeaderboard] = useState<LeaderboardEntry[]>(MOCK_LEADERBOARD);

  const [activeBossTab, setActiveBossTab] = useState<'low' | 'mid' | 'high'>('low');
  const [bossCooldown, setBossCooldown] = useState<number>(0);

  const [smithingMode, setSmithingMode] = useState<'enhance' | 'dismantle'>('enhance');
  const [selectedEnhanceSlot, setSelectedEnhanceSlot] = useState<EquipSlot | null>(null);
  const [showRatesModal, setShowRatesModal] = useState(false);
  const [selectedItem, setSelectedItem] = useState<InventoryItem | Item | null>(null);
  const [isViewingEquipped, setIsViewingEquipped] = useState<boolean>(false);
  const [isReadOnlyItem, setIsReadOnlyItem] = useState<boolean>(false);
  const [marketTab, setMarketTab] = useState<'buy' | 'sell'>('buy');
  
  const [now, setNow] = useState<number>(Date.now());
  const logCounter = useRef(0);
  const logsContainerRef = useRef<HTMLDivElement>(null);

  const [inspectingPlayer, setInspectingPlayer] = useState<LeaderboardEntry | null>(null);
  const [combatState, setCombatState] = useState<{player: Fighter, enemy: Fighter} | null>(null);

  const [showSettings, setShowSettings] = useState(false); const [isSoundEnabled, setIsSoundEnabled] = useState(true);
  const [confirmModal, setConfirmModal] = useState<{title: string, message: string, onConfirm: () => void} | null>(null);

  useEffect(() => {
    const savedUser = localStorage.getItem('ttvc_current_user');
    setTimeout(() => { if (savedUser) loadPlayerData(savedUser); else setAuthStatus(AuthStatus.LOGGED_OUT); }, 800);
    const savedBosses = localStorage.getItem(SERVER_KEY_BOSS); if (savedBosses) setBosses(JSON.parse(savedBosses));
    const savedMarket = localStorage.getItem(SERVER_KEY_MARKET); if (savedMarket) setMarketListings(JSON.parse(savedMarket)); else setMarketListings(MOCK_MARKET);
    const savedChat = localStorage.getItem(SERVER_KEY_CHAT); if (savedChat) setWorldChatMessages(JSON.parse(savedChat));
  }, []);

  const addLog = useCallback((message: string, type: LogEntry['type'] = 'normal') => { 
      const newLog: LogEntry = { id: `log-${Date.now()}-${logCounter.current++}`, message, type, timestamp: new Date().toLocaleTimeString(), }; 
      setLogs(prev => [...prev, newLog].slice(-50)); 
  }, []);

  const loadPlayerData = (username: string) => {
      const data = localStorage.getItem(USER_KEY_PREFIX + username);
      if (data) { setPlayer(JSON.parse(data)); setAuthStatus(AuthStatus.LOGGED_IN); localStorage.setItem('ttvc_current_user', username); addLog('Kết nối máy chủ thành công!', 'success'); } 
      else setLoginError('Không thể tải dữ liệu.');
  };

  const handleLogin = () => {
      setLoginError(''); setLoginSuccess('');
      if (!usernameInput.trim()) { setLoginError('Vui lòng nhập tên.'); return; } if (!passwordInput.trim()) { setLoginError('Vui lòng nhập mật khẩu.'); return; }
      const dataStr = localStorage.getItem(USER_KEY_PREFIX + usernameInput);
      if (dataStr) {
          const userData = JSON.parse(dataStr);
          if (userData.password && userData.password !== passwordInput) { setLoginError('Mật khẩu không chính xác.'); return; }
          setPlayer(userData); setAuthStatus(AuthStatus.LOGGED_IN); localStorage.setItem('ttvc_current_user', usernameInput); addLog('Chào mừng đạo hữu quay lại!', 'success');
      } else setLoginError('Tài khoản không tồn tại. Vui lòng đăng ký.');
  };

  const handleRegister = () => {
      setLoginError(''); setLoginSuccess('');
      if (!usernameInput.trim()) { setLoginError('Vui lòng nhập tên.'); return; } if (!passwordInput.trim()) { setLoginError('Vui lòng nhập mật khẩu.'); return; }
      const exists = localStorage.getItem(USER_KEY_PREFIX + usernameInput);
      if (exists) setLoginError('Tên đạo hữu đã tồn tại. Hãy chọn tên khác.');
      else {
          const newPlayer: Player = { ...INITIAL_PLAYER_STATE, id: usernameInput, username: usernameInput, password: passwordInput, name: usernameInput, lastSaveTime: Date.now() };
          localStorage.setItem(USER_KEY_PREFIX + usernameInput, JSON.stringify(newPlayer));
          setIsRegisterMode(false); setLoginSuccess('Đăng ký thành công! Hãy đăng nhập.'); setPasswordInput('');
      }
  };

  const handleLogout = () => { savePlayerData(); localStorage.removeItem('ttvc_current_user'); setAuthStatus(AuthStatus.LOGGED_OUT); setPlayer(INITIAL_PLAYER_STATE); setUsernameInput(''); setPasswordInput(''); setLoginError(''); setLoginSuccess(''); };
  const savePlayerData = useCallback((customPlayerState?: Player) => { const p = customPlayerState || player; if (authStatus === AuthStatus.LOGGED_IN && p.username) localStorage.setItem(USER_KEY_PREFIX + p.username, JSON.stringify({ ...p, lastSaveTime: Date.now() })); }, [player, authStatus]);
  useEffect(() => { const interval = setInterval(() => { savePlayerData(); setServerLatency(Math.floor(Math.random() * 50) + 20); }, 10000); return () => clearInterval(interval); }, [savePlayerData]);

  const onLogoutClick = () => { setConfirmModal({ title: "Xác nhận Đăng Xuất", message: "Bạn muốn rời khỏi Tiên Giới?", onConfirm: () => { handleLogout(); setConfirmModal(null); setShowSettings(false); } }); };
  const onResetClick = () => { setConfirmModal({ title: "Trùng Sinh (Reset)", message: "CẢNH BÁO: Toàn bộ tu vi, trang bị và tài sản sẽ bị xóa vĩnh viễn. Bạn sẽ quay lại làm Phàm Nhân. Bạn có chắc chắn không?", onConfirm: () => { const freshState: Player = { ...INITIAL_PLAYER_STATE, id: player.id, username: player.username, password: player.password, name: player.name, lastSaveTime: Date.now() }; setPlayer(freshState); savePlayerData(freshState); addLog("Đã trùng sinh! Chúc đạo hữu tu luyện lại từ đầu thuận lợi.", "info"); setConfirmModal(null); setShowSettings(false); } }); };
  const toggleSound = () => { setIsSoundEnabled(!isSoundEnabled); };

  useEffect(() => {
    const interval = setInterval(() => {
      setNow(Date.now()); setBossCooldown(prev => prev > 0 ? prev - 1 : 0);
      setPlayer(prev => {
        if (prev.qi >= prev.maxQi) return prev;
        let speed = prev.stats.speed;
        (Object.values(prev.equipment) as Item[]).forEach(item => { if(item?.stats?.speed) { const enhanceMult = 1 + ((item.enhancementLevel || 0) * 0.1); speed += parseFloat((item.stats!.speed! * enhanceMult).toFixed(2)); } });
        return { ...prev, qi: Math.min(prev.maxQi, prev.qi + speed) };
      });
      if (exploringRealmId !== null) setExplorationTimer(prev => prev <= 1 ? 0 : prev - 1);
    }, TICK_RATE_MS);
    return () => clearInterval(interval);
  }, [exploringRealmId]);

  // FIX: Xử lý hoàn thành thám hiểm khi hết thời gian
  useEffect(() => {
    if (exploringRealmId !== null && explorationTimer <= 0) {
       const realm = SECRET_REALMS.find(r => r.id === exploringRealmId);
       if (realm) {
          // Tính phần thưởng
          const stoneReward = Math.floor(Math.random() * 50 * (realm.id + 1)) + 50;

          // Drop Equipment Logic
          let droppedItem: Item | null = null;
          // 20% chance to get equipment (tỉ lệ 20% tổng thể cho các loại trang bị)
          if (Math.random() < 0.2) {
              droppedItem = generateEquipment(realm.minRealmIdx);
          }

          setPlayer(prev => {
             const newInv = [...prev.inventory];
             // Add stones
             const stoneIdx = newInv.findIndex(i => i.id === 'spirit_stone');
             if (stoneIdx > -1) newInv[stoneIdx].count += stoneReward;
             else newInv.push({ ...POSSIBLE_ITEMS[0], count: stoneReward });
             
             // Add equipment if dropped
             if (droppedItem) {
                 newInv.push({ ...droppedItem, count: 1 });
             }

             return { ...prev, inventory: newInv };
          });
          
          let msg = `Thám hiểm [${realm.name}] hoàn tất! Nhận ${stoneReward} Linh Thạch`;
          if (droppedItem) {
             msg += `, nhận được [${droppedItem.name}]`;
          }
          msg += `.`;

          addLog(msg, 'success');
          savePlayerData();
       }
       setExploringRealmId(null);
    }
  }, [explorationTimer, exploringRealmId, addLog, savePlayerData]);

  useEffect(() => { if (now % 5000 < 50) { localStorage.setItem(SERVER_KEY_BOSS, JSON.stringify(bosses)); localStorage.setItem(SERVER_KEY_MARKET, JSON.stringify(marketListings)); localStorage.setItem(SERVER_KEY_CHAT, JSON.stringify(worldChatMessages)); } }, [bosses, marketListings, worldChatMessages, now]);

  const totalStats = useMemo((): PlayerStats => {
    const current = { ...player.stats, breakthroughChance: 0 };
    let hpPercent = 0, atkPercent = 0, defPercent = 0;
    (Object.values(player.equipment) as Item[]).forEach(item => {
      if (item && item.stats) {
        const enhanceMult = 1 + ((item.enhancementLevel || 0) * 0.1);
        if (item.stats.hp) current.hp += Math.floor(item.stats.hp * enhanceMult);
        if (item.stats.atk) current.atk += Math.floor(item.stats.atk * enhanceMult);
        if (item.stats.def) current.def += Math.floor(item.stats.def * enhanceMult);
        if (item.stats.speed) current.speed += parseFloat((item.stats.speed! * enhanceMult).toFixed(2));
        if (item.stats.breakthroughChance) current.breakthroughChance! += item.stats.breakthroughChance * enhanceMult;
        if (item.stats.hpPercent) hpPercent += Math.floor(item.stats.hpPercent * enhanceMult);
        if (item.stats.atkPercent) atkPercent += Math.floor(item.stats.atkPercent * enhanceMult);
        if (item.stats.defPercent) defPercent += Math.floor(item.stats.defPercent * enhanceMult);
      }
    });
    current.hp = Math.floor(current.hp * (1 + hpPercent / 100)); current.atk = Math.floor(current.atk * (1 + atkPercent / 100)); current.def = Math.floor(current.def * (1 + defPercent / 100));
    return current;
  }, [player.stats, player.equipment]);

  const combatPower = useMemo(() => totalStats.hp + (totalStats.atk * 3) + (totalStats.def * 3), [totalStats]);
  const calculateBreakthroughRate = useCallback(() => { let penalty = 0; for (let m = 0; m <= player.majorRealmIdx; m++) { let decay = 0; if (m <= 3) decay = 2; else if (m <= 7) decay = 3; else decay = 4 + (m - 8); const levelsPassedInThisRealm = (m < player.majorRealmIdx) ? 4 : player.minorRealmIdx; penalty += levelsPassedInThisRealm * decay; } const bonus = totalStats.breakthroughChance || 0; return 100 - penalty + Math.floor(bonus); }, [player.majorRealmIdx, player.minorRealmIdx, totalStats.breakthroughChance]);
  
  const handleBreakthrough = () => {
    if (player.qi < player.maxQi) { addLog("Linh khí chưa đủ!", "fail"); return; }
    const rate = calculateBreakthroughRate();
    addLog("Đang kết nối thiên địa...", "info");
    setTimeout(() => {
        if (rate <= 0) { addLog(`Tỷ lệ đột phá ${rate}% (Quá thấp)! Thiên địa từ chối.`, "fail"); return; }
        if (Math.random() * 100 <= rate) {
          const isMajor = player.minorRealmIdx >= 3; const newMajor = isMajor ? player.majorRealmIdx + 1 : player.majorRealmIdx; const newMinor = isMajor ? 0 : player.minorRealmIdx + 1; const statMult = isMajor ? 1.5 : 1.1;
          addLog(`Đột phá thành công lên ${MAJOR_REALMS[newMajor]} ${MINOR_REALMS[newMinor]}!`, "success");
          setPlayer(prev => ({ ...prev, majorRealmIdx: newMajor, minorRealmIdx: newMinor, qi: 0, maxQi: Math.ceil(prev.maxQi * 1.5), stats: { hp: Math.max(Math.ceil(prev.stats.hp * statMult), prev.stats.hp + 1), atk: Math.max(Math.ceil(prev.stats.atk * statMult), prev.stats.atk + 1), def: Math.max(Math.ceil(prev.stats.def * statMult), prev.stats.def + 1), speed: Math.ceil(prev.stats.speed * 1.2), breakthroughChance: 0 } }));
        } else { const lostQi = Math.floor(player.maxQi * 0.5); addLog(`Đột phá thất bại! Mất ${lostQi} Linh khí.`, "fail"); setPlayer(prev => ({ ...prev, qi: Math.max(0, prev.qi - lostQi) })); }
        savePlayerData();
    }, 500);
  };

  const handleEnhance = () => {
    if (!selectedEnhanceSlot) return; const item = player.equipment[selectedEnhanceSlot]; if (!item) return;
    const currentLevel = item.enhancementLevel || 0; if (currentLevel >= 16) { addLog("Trang bị đã đạt cấp tối đa!", "fail"); return; }
    const { costIron, costStones } = calculateEnhanceCost(currentLevel); const stones = player.inventory.find(i => i.id === 'spirit_stone')?.count || 0; const iron = player.inventory.find(i => i.id === 'black_iron')?.count || 0;
    if (stones < costStones || iron < costIron) { addLog("Không đủ nguyên liệu!", "fail"); return; }
    setTimeout(() => {
        setPlayer(prev => { const newInv = prev.inventory.map(i => { if (i.id === 'spirit_stone') return { ...i, count: i.count - costStones }; if (i.id === 'black_iron') return { ...i, count: i.count - costIron }; return i; }); return { ...prev, inventory: newInv }; });
        const chance = calculateEnhanceChance(currentLevel);
        if (Math.random() * 100 < chance) { setPlayer(prev => ({ ...prev, equipment: { ...prev.equipment, [selectedEnhanceSlot]: { ...item, enhancementLevel: currentLevel + 1 } } })); addLog(`Cường hóa thành công lên +${currentLevel + 1}!`, 'success'); } else { addLog(`Cường hóa thất bại!`, 'fail'); }
        savePlayerData();
    }, 400);
  };

  const handleDismantle = (item: Item) => { const amt = DISMANTLE_RATES[item.rarity] || 1; setPlayer(prev => { const newInv = prev.inventory.filter(i => i.id !== item.id); const ironIdx = newInv.findIndex(i => i.id === 'black_iron'); if (ironIdx > -1) newInv[ironIdx].count += amt; else newInv.push({ ...POSSIBLE_ITEMS[1], count: amt }); return { ...prev, inventory: newInv }; }); addLog(`Đã phân rã [${item.name}]. Nhận ${amt} Hắc Thiết.`, 'info'); savePlayerData(); };
  const attackBoss = (bossId: string) => { if (bossCooldown > 0) return; setBossCooldown(3); const dmg = totalStats.atk; const rewardStones = Math.floor(dmg / 500); setBosses(prev => prev.map(b => { if (b.id !== bossId || b.status === 'dead') return b; const newHp = Math.max(0, b.currentHp - dmg); const isDead = newHp === 0; if (isDead) addLog(`Bạn đã tiêu diệt ${b.name}!`, 'success'); else if (rewardStones > 0) addLog(`Tấn công ${b.name}: ${dmg.toLocaleString()} ST. +${rewardStones} Linh Thạch.`, 'combat'); else addLog(`Tấn công ${b.name}: ${dmg.toLocaleString()} ST.`, 'combat'); return { ...b, currentHp: newHp, status: isDead ? 'dead' : 'alive', respawnTime: isDead ? Date.now() + 3600000 : undefined }; })); if (rewardStones > 0) { setPlayer(prev => { const newInv = [...prev.inventory]; const stonesIdx = newInv.findIndex(i => i.id === 'spirit_stone'); if (stonesIdx > -1) newInv[stonesIdx].count += rewardStones; else newInv.push({ ...POSSIBLE_ITEMS[0], count: rewardStones }); return { ...prev, inventory: newInv }; }); } };
  const handleChatSend = () => { if (!chatInputValue.trim()) return; const msg: ChatMessage = { id: `msg_${Date.now()}`, sender: player.name || 'Vô Danh', content: chatInputValue, isSystem: false, timestamp: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) }; setWorldChatMessages(prev => [...prev, msg].slice(-50)); setChatInputValue(''); };
  const handleMarketList = (item: Item, price: number) => { setPlayer(prev => ({ ...prev, inventory: prev.inventory.filter(i => i.id !== item.id) })); const newListing: MarketListing = { id: `m_${Date.now()}_${player.username}`, sellerName: player.name || 'Vô Danh', sellerId: player.username, price: price, timestamp: Date.now(), item: item }; setMarketListings(prev => [newListing, ...prev]); addLog(`Đã đăng bán [${item.name}] lên chợ.`, 'info'); savePlayerData(); };
  const handleMarketBuy = (listing: MarketListing) => { if (listing.sellerId === player.username) { addLog("Không thể mua vật phẩm của chính mình!", "fail"); return; } const playerMoney = player.inventory.find(i => i.id === 'spirit_stone')?.count || 0; if (playerMoney < listing.price) { addLog("Không đủ Linh Thạch!", "fail"); return; } setPlayer(prev => { const newInv = prev.inventory.map(i => i.id === 'spirit_stone' ? { ...i, count: i.count - listing.price } : i); newInv.push({ ...listing.item, count: 1 }); return { ...prev, inventory: newInv }; }); setMarketListings(prev => prev.filter(l => l.id !== listing.id)); addLog(`Đã mua [${listing.item.name}] giá ${listing.price.toLocaleString()} LT.`, 'success'); savePlayerData(); };
  const handleConfirmExploration = (realm: SecretRealm) => { setPreviewRealm(null); if (player.majorRealmIdx < realm.minRealmIdx) { addLog(`Cảnh giới chưa đủ!`, 'fail'); return; } setExploringRealmId(realm.id); setExplorationTimer(realm.id === 9 ? 600 : 300); addLog(`Bắt đầu thám hiểm ${realm.name}...`, 'info'); };
  const handleSpar = (entry: LeaderboardEntry) => { const pFighter: Fighter = { id: 'p', name: player.name || 'Bạn', maxHp: totalStats.hp, currentHp: totalStats.hp, atk: totalStats.atk, def: totalStats.def, speed: totalStats.speed, isPlayer: true }; const botStats = entry.stats; const eFighter: Fighter = { id: 'e', name: entry.name, maxHp: botStats.hp, currentHp: botStats.hp, atk: botStats.atk, def: botStats.def, speed: botStats.speed, isPlayer: false }; setCombatState({ player: pFighter, enemy: eFighter }); };
  const handleSlotClick = (slot: EquipSlot) => { if (activeTab === TabType.SMITHING) { setSmithingMode('enhance'); setSelectedEnhanceSlot(slot); } else if (player.equipment[slot]) { setSelectedItem(player.equipment[slot]!); setIsViewingEquipped(true); setIsReadOnlyItem(false); } };
  
  const inventoryStones = player.inventory.find(i => i.id === 'spirit_stone')?.count || 0; const inventoryIron = player.inventory.find(i => i.id === 'black_iron')?.count || 0; const activeBoss = activeBossTab === 'low' ? bosses.find(b=>b.id==='boss_low') : activeBossTab === 'mid' ? bosses.find(b=>b.id==='boss_mid') : bosses.find(b=>b.id==='boss_high');

  if (authStatus === AuthStatus.CHECKING) { return <div className="min-h-screen bg-void-900 flex items-center justify-center text-gold-400 font-mono animate-pulse">Đang kết nối máy chủ...</div>; }
  if (authStatus === AuthStatus.LOGGED_OUT) { return (<div className="min-h-screen bg-void-900 flex flex-col items-center justify-center p-4 relative overflow-hidden"><div className="absolute inset-0 z-0 opacity-20"><CultivationCanvas realmIdx={9} isCultivating={true} /></div><div className="bg-void-800 p-8 rounded-xl border-2 border-gold-500 shadow-[0_0_50px_rgba(234,179,8,0.3)] z-10 w-full max-w-md backdrop-blur-md"><div className="flex justify-center mb-6"><CanvasIcon type="crown" size={64} color="#ffd700"/></div><h1 className="text-3xl font-bold text-center text-gold-400 mb-8 uppercase tracking-widest drop-shadow-md">Tu Tiên Vô Cực<br/><span className="text-sm text-gray-400 normal-case tracking-normal">Online Server</span></h1><div className="flex mb-6 border-b border-void-600"><button onClick={() => { setIsRegisterMode(false); setLoginError(''); setLoginSuccess(''); }} className={`flex-1 py-2 font-bold ${!isRegisterMode ? 'text-gold-400 border-b-2 border-gold-400' : 'text-gray-500 hover:text-gray-300'}`}>ĐĂNG NHẬP</button><button onClick={() => { setIsRegisterMode(true); setLoginError(''); setLoginSuccess(''); }} className={`flex-1 py-2 font-bold ${isRegisterMode ? 'text-gold-400 border-b-2 border-gold-400' : 'text-gray-500 hover:text-gray-300'}`}>ĐĂNG KÝ</button></div>{loginError && <div className="bg-red-900/50 border border-red-700 text-red-200 text-xs p-3 rounded mb-4 text-center">{loginError}</div>}{loginSuccess && <div className="bg-green-900/50 border border-green-700 text-green-200 text-xs p-3 rounded mb-4 text-center">{loginSuccess}</div>}<input type="text" placeholder="Tên Đạo Hữu (Username)" value={usernameInput} onChange={e => setUsernameInput(e.target.value)} className="w-full bg-void-900 border border-void-600 rounded p-3 mb-4 text-white focus:border-gold-500 outline-none"/><input type="password" placeholder="Mật khẩu" value={passwordInput} onChange={e => setPasswordInput(e.target.value)} className="w-full bg-void-900 border border-void-600 rounded p-3 mb-6 text-white focus:border-gold-500 outline-none"/>{isRegisterMode ? (<button onClick={handleRegister} className="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded shadow-lg transition-transform active:scale-95">TẠO NHÂN VẬT</button>) : (<button onClick={handleLogin} className="w-full bg-gold-600 hover:bg-gold-500 text-black font-bold py-3 rounded shadow-lg transition-transform active:scale-95">BƯỚC VÀO TIÊN GIỚI</button>)}<div className="text-center text-gray-500 text-xs mt-4">Phiên bản giả lập Online v1.1 • Dữ liệu lưu tại LocalStorage</div></div></div>); }

  return (
    <div className="min-h-screen bg-void-900 text-gray-200 font-sans flex flex-col overflow-hidden selection:bg-gold-500/30 relative">
      <header className="h-16 bg-void-800 border-b border-void-700 flex items-center justify-center relative px-4 shadow-xl z-30 shrink-0">
        <div className="absolute left-4 flex gap-2 items-center"><div className="p-2 bg-void-700/50 rounded-full border border-gold-500/20 hidden sm:block"><CanvasIcon type="crown" size={24} color="#ffd700"/></div><div className="text-[10px] flex flex-col text-gray-400"><span className="font-bold text-gold-400">{player.name}</span><span className="flex items-center gap-1"><div className="w-2 h-2 rounded-full bg-green-500"></div> Ping: {serverLatency}ms</span></div></div>
        <h1 className="text-xl md:text-3xl font-bold text-gold-400 uppercase tracking-[0.2em] text-center drop-shadow-[0_2px_4px_rgba(0,0,0,0.8)]">TU TIÊN VÔ CỰC</h1>
        <div className="absolute right-2"><button onClick={() => setShowSettings(!showSettings)} className="w-10 h-10 rounded-full bg-void-700 border border-void-600 hover:bg-void-600 flex items-center justify-center shadow-lg transition-all active:scale-95"><CanvasIcon type="settings" size={20} color="#9ca3af" /></button>{showSettings && (<div className="absolute top-12 right-0 bg-void-800 border border-void-600 rounded-lg shadow-2xl w-48 py-2 z-50 animate-fadeIn overflow-hidden"><button onClick={toggleSound} className="w-full text-left px-4 py-3 hover:bg-void-700 flex items-center gap-3 transition-colors border-b border-void-700/50"><CanvasIcon type={isSoundEnabled ? 'sound_on' : 'sound_off'} size={18} color={isSoundEnabled ? '#4ade80' : '#9ca3af'} /><span className="text-green-400" : 'text-gray-400'}>Âm Thanh: {isSoundEnabled ? 'Bật' : 'Tắt'}</span></button><button onClick={onResetClick} className="w-full text-left px-4 py-3 hover:bg-red-900/20 flex items-center gap-3 transition-colors border-b border-void-700/50 group"><CanvasIcon type="trash" size={18} color="#ef4444" /><span className="text-red-400 group-hover:text-red-300">Trùng Sinh (Reset)</span></button><button onClick={onLogoutClick} className="w-full text-left px-4 py-3 hover:bg-void-700 flex items-center gap-3 transition-colors group"><CanvasIcon type="logout" size={18} color="#facc15" /><span className="text-gray-300 group-hover:text-white">Đăng Xuất</span></button></div>)}</div>
      </header>
      {confirmModal && (<div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/90 backdrop-blur-sm animate-fadeIn"><div className="bg-void-800 border-2 border-void-600 rounded-xl shadow-2xl max-w-sm w-full p-6 text-center"><h3 className="text-xl font-bold text-gold-400 mb-4 uppercase">{confirmModal.title}</h3><p className="text-gray-300 mb-6">{confirmModal.message}</p><div className="grid grid-cols-2 gap-4"><button onClick={() => setConfirmModal(null)} className="py-2 rounded border border-void-600 hover:bg-void-700 text-gray-400">Từ Chối</button><button onClick={confirmModal.onConfirm} className="py-2 rounded bg-red-600 hover:bg-red-500 text-white font-bold shadow-lg">Xác Nhận</button></div></div></div>)}
      <main className="flex-1 p-2 md:p-4 flex flex-col lg:flex-row gap-4 max-w-7xl mx-auto w-full overflow-hidden">
        <section className="w-full lg:w-72 flex flex-col gap-4 overflow-y-auto lg:overflow-visible shrink-0"><div className="bg-void-800 rounded-lg border border-void-700 shadow-xl overflow-hidden relative group"><div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-[60%] z-10 text-center pointer-events-none"><div className="text-xl font-bold text-gold-400 drop-shadow-md whitespace-nowrap">{MAJOR_REALMS[player.majorRealmIdx]}</div><div className="text-sm text-gold-600/80 font-mono tracking-widest">{MINOR_REALMS[player.minorRealmIdx]}</div></div><CultivationCanvas realmIdx={player.majorRealmIdx} isCultivating={player.qi < player.maxQi} /><div className="p-4 bg-gradient-to-b from-void-800 to-void-900"><div className="flex justify-between items-end text-[11px] mb-2 font-bold uppercase tracking-wide"><span className={`${calculateBreakthroughRate() <= 0 ? 'text-red-500' : 'text-green-400'} drop-shadow-sm`}>Tỷ lệ {calculateBreakthroughRate()}%</span><span className="text-red-500 drop-shadow-sm">-50% KN</span></div><ProgressBar current={Math.floor(player.qi)} max={player.maxQi} label="Linh Khí" /><button onClick={handleBreakthrough} disabled={player.qi < player.maxQi} className={`mt-3 w-full py-2.5 rounded font-bold uppercase tracking-wide transition-all duration-300 relative overflow-hidden group text-sm ${player.qi >= player.maxQi ? 'bg-gradient-to-r from-red-900 to-red-700 text-white shadow-[0_0_15px_rgba(220,38,38,0.4)] hover:scale-[1.02] active:scale-[0.98]' : 'bg-void-700 text-gray-600 cursor-not-allowed border border-void-600'}`}>{player.qi >= player.maxQi ? <span className="animate-pulse">Đột Phá Cảnh Giới</span> : "Đang Tích Lũy..."}</button></div></div><div className="bg-void-800 p-4 rounded-lg border border-void-700 shadow-md flex-1"><h3 className="text-gray-500 font-bold uppercase text-xs mb-3 tracking-wider border-b border-void-700 pb-2">Thuộc Tính Cơ Bản</h3><StatRow label="Lực Chiến" value={combatPower.toLocaleString()} icon={<CanvasIcon type="zap" size={14} color="#f97316"/>} /><StatRow label="Sinh Lực" value={totalStats.hp.toLocaleString()} icon={<CanvasIcon type="heart" size={14} color="#ef4444"/>} /><StatRow label="Công Kích" value={totalStats.atk.toLocaleString()} icon={<CanvasIcon type="sword" size={14} color="#eab308"/>} /><StatRow label="Phòng Thủ" value={totalStats.def.toLocaleString()} icon={<CanvasIcon type="shield" size={14} color="#3b82f6"/>} /><StatRow label="Tốc độ" value={totalStats.speed.toFixed(1)} subLabel="/s" icon={<span className="w-4 text-center">⚡</span>} /></div></section>
        <section className="flex-1 flex flex-col gap-4 overflow-hidden min-h-[500px]"><div className="flex-1 bg-void-800 border border-void-700 rounded-lg flex flex-col overflow-hidden shadow-xl"><div className="grid grid-cols-6 bg-void-900 shadow-md border-b border-void-700">{[{ id: TabType.SMITHING, label: 'Rèn', icon: 'hammer' },{ id: TabType.INVENTORY, label: 'Túi', icon: 'bag' },{ id: TabType.MARKET, label: 'Chợ', icon: 'market' },{ id: TabType.FEATURES, label: 'Bí Cảnh', icon: 'book' },{ id: TabType.BOSS, label: 'Boss', icon: 'skull' },{ id: TabType.LEADERBOARD, label: 'BXH', icon: 'trophy' }].map(t => (<button key={t.id} onClick={() => setActiveTab(t.id as TabType)} className={`flex flex-col items-center justify-center gap-1 py-3 font-bold text-[10px] sm:text-xs uppercase transition-all ${activeTab === t.id ? 'text-gold-400 bg-void-800 border-b-2 border-gold-400 shadow-[inset_0_0_10px_rgba(0,0,0,0.5)]' : 'text-gray-500 hover:text-gray-300 hover:bg-void-800 border-b-2 border-transparent'}`}><CanvasIcon type={t.icon as IconType} size={16} color={activeTab === t.id ? '#ffd700' : '#6b7280'} /> <span className="hidden sm:inline">{t.label}</span></button>))}</div><div className="p-3 md:p-4 flex-1 overflow-y-auto bg-void-800 relative scrollbar-thin scrollbar-thumb-void-600">{activeTab === TabType.SMITHING && (<div className="h-full flex flex-col"><div className="flex justify-between items-center mb-4"><div><h4 className="font-bold text-gold-400 text-lg">Lò Rèn Tạo Hóa</h4></div><div className="flex gap-2"><button onClick={() => setSmithingMode('enhance')} className={`text-xs px-3 py-1 rounded border ${smithingMode==='enhance'?'bg-gold-600 border-gold-500 text-black font-bold':'bg-void-900 border-void-600 text-gray-500'}`}>Cường Hóa</button><button onClick={() => setSmithingMode('dismantle')} className={`text-xs px-3 py-1 rounded border ${smithingMode==='dismantle'?'bg-red-900 border-red-700 text-red-200 font-bold':'bg-void-900 border-void-600 text-gray-500'}`}>Phân Rã</button></div></div>{smithingMode === 'enhance' ? (<><div className="flex justify-end mb-4"><button onClick={() => setShowRatesModal(true)} className="text-xs text-blue-400 hover:text-blue-300 underline flex items-center gap-1"><CanvasIcon type="book" size={12} color="#60a5fa"/> Xem Tỷ Lệ</button></div><div className="flex flex-col items-center justify-center gap-8 flex-1"><div className="grid grid-cols-6 gap-2 sm:gap-4">{Object.values(EquipSlot).map(slot => (<EquipmentSlotComponent key={slot} slot={slot} player={player} selectedEnhanceSlot={selectedEnhanceSlot} activeTab={activeTab} smithingMode={smithingMode} onClick={handleSlotClick} />))}</div><div className="w-full max-w-md bg-void-900 border border-void-700 rounded-xl p-6 flex flex-col items-center text-center shadow-2xl relative overflow-hidden"><div className="absolute inset-0 bg-gradient-to-b from-transparent to-black/30 pointer-events-none"></div>{selectedEnhanceSlot ? (player.equipment[selectedEnhanceSlot] ? (<div className="relative z-10 w-full"><div className="w-24 h-24 mx-auto mb-4 border-2 border-void-700 rounded-lg p-4 bg-void-800"><EquipIcon slot={selectedEnhanceSlot} color={getRarityHex(player.equipment[selectedEnhanceSlot]!.rarity)} className="w-full h-full drop-shadow-md"/></div><div className={`mb-4 text-xl font-bold ${getRarityColor(player.equipment[selectedEnhanceSlot]!.rarity)}`}>{player.equipment[selectedEnhanceSlot]!.name} <span className="text-white ml-1">+{player.equipment[selectedEnhanceSlot]!.enhancementLevel}</span></div><div className="w-full grid grid-cols-2 gap-4 mb-6"><div className="bg-void-800 p-3 rounded-lg border border-void-600 shadow-inner"><div className="text-[10px] text-gray-500 uppercase tracking-widest mb-1">Hắc Thiết</div><div className={`font-mono font-bold text-lg ${inventoryIron >= calculateEnhanceCost(player.equipment[selectedEnhanceSlot]!.enhancementLevel || 0).costIron ? "text-green-400" : "text-red-500"}`}>{calculateEnhanceCost(player.equipment[selectedEnhanceSlot]!.enhancementLevel || 0).costIron.toLocaleString()}</div></div><div className="bg-void-800 p-3 rounded-lg border border-void-600 shadow-inner"><div className="text-[10px] text-gray-500 uppercase tracking-widest mb-1">Linh Thạch</div><div className={`font-mono font-bold text-lg ${inventoryStones >= calculateEnhanceCost(player.equipment[selectedEnhanceSlot]!.enhancementLevel || 0).costStones ? "text-gold-400" : "text-red-500"}`}>{calculateEnhanceCost(player.equipment[selectedEnhanceSlot]!.enhancementLevel || 0).costStones.toLocaleString()}</div></div></div><button onClick={handleEnhance} disabled={(player.equipment[selectedEnhanceSlot]!.enhancementLevel || 0) >= 16} className={`w-full font-bold py-3 rounded-lg shadow-lg border active:scale-95 transition-all ${(player.equipment[selectedEnhanceSlot]!.enhancementLevel || 0) >= 16 ? 'bg-void-700 text-gray-500 border-void-600 cursor-not-allowed' : 'bg-gradient-to-r from-orange-800 to-orange-600 hover:from-orange-700 hover:to-orange-500 text-white border-orange-500'}`}>{(player.equipment[selectedEnhanceSlot]!.enhancementLevel || 0) >= 16 ? 'Đã Đạt Giới Hạn' : `Cường Hóa (${calculateEnhanceChance(player.equipment[selectedEnhanceSlot]!.enhancementLevel || 0)}%)`}</button></div>) : (<div className="text-gray-500 italic py-10">Chưa mặc trang bị ở vị trí này.</div>)) : (<div className="text-gray-500 italic py-10">Chọn một vị trí trang bị để bắt đầu.</div>)}</div></div></>) : (<div className="flex-1 flex flex-col"><p className="text-gray-400 text-sm mb-4 text-center">Phân rã trang bị để lấy Hắc Thiết.</p><div className="grid grid-cols-1 sm:grid-cols-2 gap-2 overflow-y-auto">{player.inventory.filter(i => i.type === ItemType.EQUIPMENT).length === 0 ? (<div className="col-span-full text-center text-gray-500 py-10">Túi đồ không có trang bị nào.</div>) : (player.inventory.filter(i => i.type === ItemType.EQUIPMENT).map((item, idx) => (<div key={item.id} className="bg-void-900 border border-void-700 p-2 rounded flex justify-between items-center hover:border-red-500/50"><div className="flex items-center gap-2"><div className={`w-8 h-8 rounded border flex items-center justify-center ${getRarityColor(item.rarity)}`}>{item.slot ? <EquipIcon slot={item.slot} color={getRarityHex(item.rarity)} className="w-5 h-5"/> : <CanvasIcon type="sword" size={16}/>}</div><div><div className={`text-xs font-bold ${getRarityColor(item.rarity)}`}>{item.name} +{item.enhancementLevel || 0}</div></div></div><button onClick={() => handleDismantle(item)} className="bg-void-800 hover:bg-red-900 text-red-400 border border-void-600 hover:border-red-700 px-3 py-1 text-xs rounded transition-colors">Phân Rã</button></div>)))}</div></div>)}</div>)}{activeTab === TabType.INVENTORY && (<div className="flex flex-col gap-4 h-full"><div className="bg-void-900 p-3 rounded border border-void-700 shrink-0 shadow-inner"><div className="flex justify-between items-center mb-2 px-1"><h4 className="text-xs font-bold text-gray-500 uppercase tracking-wider">Đang Trang Bị</h4><div className="text-xs font-mono text-gold-400">Lực Chiến: {combatPower.toLocaleString()}</div></div><div className="flex justify-center sm:justify-between gap-2 overflow-x-auto pb-1 scrollbar-none"><EquipmentSlotComponent slot={EquipSlot.WEAPON} player={player} selectedEnhanceSlot={selectedEnhanceSlot} activeTab={activeTab} smithingMode={smithingMode} onClick={handleSlotClick} /><EquipmentSlotComponent slot={EquipSlot.HEAD} player={player} selectedEnhanceSlot={selectedEnhanceSlot} activeTab={activeTab} smithingMode={smithingMode} onClick={handleSlotClick} /><EquipmentSlotComponent slot={EquipSlot.BODY} player={player} selectedEnhanceSlot={selectedEnhanceSlot} activeTab={activeTab} smithingMode={smithingMode} onClick={handleSlotClick} /><EquipmentSlotComponent slot={EquipSlot.RING} player={player} selectedEnhanceSlot={selectedEnhanceSlot} activeTab={activeTab} smithingMode={smithingMode} onClick={handleSlotClick} /><EquipmentSlotComponent slot={EquipSlot.AMULET} player={player} selectedEnhanceSlot={selectedEnhanceSlot} activeTab={activeTab} smithingMode={smithingMode} onClick={handleSlotClick} /><EquipmentSlotComponent slot={EquipSlot.FEET} player={player} selectedEnhanceSlot={selectedEnhanceSlot} activeTab={activeTab} smithingMode={smithingMode} onClick={handleSlotClick} /></div></div><div className="flex gap-4 text-xs font-mono bg-void-900 p-2 rounded border border-void-700 shrink-0 justify-around"><div className="flex items-center gap-1 text-gold-400 font-bold"><div className="w-2 h-2 rounded-full bg-gold-500"></div> Linh Thạch: {inventoryStones.toLocaleString()}</div><div className="flex items-center gap-1 text-gray-400"><div className="w-2 h-2 rounded-full bg-gray-500"></div> Hắc Thiết: {inventoryIron.toLocaleString()}</div></div><div className="flex-1 overflow-y-auto pr-1"><div className="grid grid-cols-4 sm:grid-cols-5 md:grid-cols-6 lg:grid-cols-8 gap-2">{player.inventory.map((item, idx) => (<div key={idx} onClick={() => { setSelectedItem(item); setIsViewingEquipped(false); setIsReadOnlyItem(false); }} className={`aspect-square border border-void-600 bg-void-900 rounded cursor-pointer hover:border-gray-400 relative flex items-center justify-center p-2 group transition-transform hover:scale-105 ${getRarityColor(item.rarity)}`}>{item.type === ItemType.RESOURCE ? (<div className="text-[10px] text-center leading-tight">{item.name}</div>) : (item.slot ? <EquipIcon slot={item.slot} color={getRarityHex(item.rarity)} className="w-full h-full"/> : <CanvasIcon type="sword" size={20} color={getRarityHex(item.rarity)} />)}<span className="absolute bottom-0.5 right-1 text-[10px] font-mono text-white bg-black/60 px-1 rounded">{item.count > 1 ? item.count : ''}</span></div>))}{Array.from({length: Math.max(0, 48 - player.inventory.length)}).map((_, i) => (<div key={`empty-${i}`} className="aspect-square border border-void-700 bg-void-900/50 rounded opacity-30"></div>))}</div></div></div>)}{activeTab === TabType.MARKET && (<div className="flex flex-col gap-4 h-full"><div className="flex justify-between items-center bg-void-900 p-2 rounded border border-void-700"><div className="flex gap-2"><button onClick={() => setMarketTab('buy')} className={`px-3 py-1 rounded text-xs font-bold transition-colors ${marketTab === 'buy' ? 'bg-gold-600 text-black' : 'bg-void-800 text-gray-400 hover:text-white'}`}>MUA</button><button onClick={() => setMarketTab('sell')} className={`px-3 py-1 rounded text-xs font-bold transition-colors ${marketTab === 'sell' ? 'bg-blue-600 text-white' : 'bg-void-800 text-gray-400 hover:text-white'}`}>BÁN</button></div><span className="text-xs text-gold-400 font-bold">{inventoryStones.toLocaleString()} LT</span></div><div className="flex-1 overflow-y-auto space-y-2 pr-1">{marketTab === 'buy' ? (marketListings.length === 0 ? <div className="text-center text-gray-500 py-10">Chợ trống vắng...</div> : marketListings.map(listing => (<div key={listing.id} className="bg-void-900 border border-void-700 p-2 rounded flex items-center gap-3 hover:border-gold-600 transition-colors group"><div onClick={() => { setSelectedItem(listing.item); setIsReadOnlyItem(true); }} className={`w-12 h-12 border rounded flex items-center justify-center shrink-0 cursor-pointer hover:scale-105 transition-transform p-1.5 ${getRarityColor(listing.item.rarity)}`}>{listing.item.slot ? <EquipIcon slot={listing.item.slot} color={getRarityHex(listing.item.rarity)} className="w-full h-full"/> : <CanvasIcon type="sword" size={20} color={getRarityHex(listing.item.rarity)}/>}</div><div className="flex-1 min-w-0"><div onClick={() => { setSelectedItem(listing.item); setIsReadOnlyItem(true); }} className={`font-bold truncate cursor-pointer hover:underline ${getRarityColor(listing.item.rarity)}`}>{listing.item.name} {listing.item.enhancementLevel ? `+${listing.item.enhancementLevel}` : ''}</div><div className="text-xs text-gray-500">Người bán: {listing.sellerName}</div><div className="text-xs text-gold-400 mt-1">{listing.price.toLocaleString()} LT</div></div><button onClick={() => handleMarketBuy(listing)} disabled={listing.sellerId === player.username} className={`px-3 py-1.5 text-black text-xs font-bold rounded shadow transition-shadow ${listing.sellerId === player.username ? 'bg-void-700 text-gray-500' : 'bg-gold-600 hover:bg-gold-500 group-hover:shadow-gold-500/50'}`}>{listing.sellerId === player.username ? 'Của Bạn' : 'MUA'}</button></div>))) : (<div className="grid grid-cols-4 sm:grid-cols-5 md:grid-cols-6 gap-2">{player.inventory.filter(i => i.type === ItemType.EQUIPMENT).length === 0 ? <div className="col-span-full text-center text-gray-500 py-10">Không có trang bị để bán.</div> : player.inventory.filter(i => i.type === ItemType.EQUIPMENT).map((item, idx) => (<div key={idx} onClick={() => { setSelectedItem(item); setIsViewingEquipped(false); setIsReadOnlyItem(false); }} className={`aspect-square border border-void-600 bg-void-900 rounded cursor-pointer hover:border-blue-500 relative flex flex-col items-center justify-center p-2 group ${getRarityColor(item.rarity)}`}>{item.slot ? <EquipIcon slot={item.slot} color={getRarityHex(item.rarity)} className="w-full h-full"/> : <CanvasIcon type="sword" size={20} color={getRarityHex(item.rarity)} />}<div className="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 flex items-center justify-center transition-opacity"><span className="text-[10px] bg-blue-600 text-white px-1 rounded">BÁN</span></div></div>))}</div>)}</div></div>)}{activeTab === TabType.BOSS && (<div className="flex flex-col h-full"><div className="flex justify-center gap-2 mb-6">{[{ id: 'low', label: 'Hạ Vị', color: 'text-green-500 border-green-500' },{ id: 'mid', label: 'Trung Vị', color: 'text-orange-500 border-orange-500' },{ id: 'high', label: 'Thượng Vị', color: 'text-red-500 border-red-500' }].map(tab => (<button key={tab.id} onClick={() => setActiveBossTab(tab.id as any)} className={`px-4 py-1.5 rounded-full border text-xs font-bold transition-all ${activeBossTab === tab.id ? `${tab.color} bg-void-700 shadow-md` : 'border-void-600 text-gray-600 bg-void-900 hover:bg-void-800'}`}>{tab.label}</button>))}</div><div className="flex-1 flex items-center justify-center">{activeBoss && (<div className={`w-full max-w-lg p-6 rounded-xl border-2 flex flex-col gap-6 relative overflow-hidden transition-all duration-500 ${activeBossTab === 'high' ? 'border-red-600 bg-red-900/20 shadow-red-500/20' : activeBossTab === 'mid' ? 'border-orange-600 bg-orange-900/20 shadow-orange-500/20' : 'border-green-600 bg-green-900/20 shadow-green-500/20'}`}><div className={`absolute top-0 right-0 w-32 h-32 blur-[60px] opacity-20 ${activeBossTab==='high'?'bg-red-600':activeBossTab==='mid'?'bg-orange-500':'bg-green-500'}`}></div><div className="relative z-10"><BossCanvas type={activeBossTab} /></div><div className="text-center z-10"><div className="text-xs font-mono text-gray-400 uppercase tracking-widest mb-1">Cấp Độ {activeBoss.level}</div><h2 className={`text-2xl md:text-3xl font-bold uppercase drop-shadow-md ${activeBossTab==='high'?'text-red-500':activeBossTab==='mid'?'text-orange-500':'text-green-500'}`}>{activeBoss.name}</h2><div className="text-gray-400 italic mt-2 text-sm">{activeBoss.description}</div></div><div className="z-10 bg-black/40 p-4 rounded-lg border border-void-700/50">{activeBoss.status === 'alive' ? (<><div className="flex justify-between text-xs text-gray-300 mb-1"><span>Sinh Lực</span><span>{Math.floor((activeBoss.currentHp/activeBoss.maxHp)*100)}%</span></div><ProgressBar current={activeBoss.currentHp} max={activeBoss.maxHp} colorClass={activeBossTab === 'high' ? 'bg-red-600' : activeBossTab === 'mid' ? 'bg-orange-500' : 'bg-green-500'} /></>) : (<div className="text-center py-2"><div className="text-gray-500 mb-2">Đã bị tiêu diệt</div><div className="text-xl font-mono text-white animate-pulse">Hồi sinh: {Math.floor(((activeBoss.respawnTime || 0) - now)/1000)}s</div></div>)}</div><button onClick={() => attackBoss(activeBoss.id)} disabled={activeBoss.status === 'dead' || bossCooldown > 0} className={`w-full py-4 rounded-lg font-bold text-lg uppercase tracking-wider shadow-xl transition-all z-10 border border-white/10 ${activeBoss.status === 'dead' || bossCooldown > 0 ? 'bg-void-800 text-gray-600 cursor-not-allowed' : `${activeBossTab==='high'?'bg-red-800 hover:bg-red-700':activeBossTab==='mid'?'bg-orange-800 hover:bg-orange-700':'bg-green-800 hover:bg-green-700'} text-white active:scale-[0.98]`}`}>{activeBoss.status === 'dead' ? 'Chờ Hồi Sinh' : bossCooldown > 0 ? `Chờ ${bossCooldown}s` : 'Tấn Công Ngay'}</button></div>)}</div></div>)}{activeTab === TabType.FEATURES && (<div className="grid grid-cols-1 sm:grid-cols-2 gap-3 pb-2">{SECRET_REALMS.map(realm => (<div key={realm.id} className="p-4 bg-void-900 border border-void-700 rounded hover:border-gold-500/30 transition-all group relative overflow-hidden flex flex-col justify-between"><div className="relative z-10"><div className="flex justify-between items-start mb-2"><h5 className="font-bold text-gray-200 group-hover:text-gold-400">{realm.name}</h5><span className={`text-[10px] px-2 py-0.5 rounded border ${player.majorRealmIdx >= realm.minRealmIdx ? 'border-green-800 text-green-500' : 'border-red-900 text-red-500'}`}>Yêu cầu: {MAJOR_REALMS[realm.minRealmIdx]}</span></div><p className="text-xs text-gray-500 mb-3 min-h-[30px]">{realm.description}</p></div>{exploringRealmId === realm.id ? (<div className="mt-auto bg-void-950 rounded border border-gold-500/50 p-2 flex items-center justify-between shadow-[0_0_10px_rgba(234,179,8,0.2)]"><div className="flex items-center gap-2"><div className="w-2 h-2 bg-gold-500 rounded-full animate-pulse"></div><span className="text-gold-400 text-xs font-bold uppercase tracking-wider">Đang thám hiểm</span></div><span className="font-mono font-bold text-white text-sm">{Math.floor(explorationTimer/60)}:{(explorationTimer%60).toString().padStart(2,'0')}</span></div>) : exploringRealmId !== null ? (<button disabled className="w-full py-2 bg-void-800 text-gray-600 rounded border border-void-700 cursor-not-allowed mt-auto">Đang bận</button>) : (<button onClick={() => { setPreviewRealm(realm); }} className="w-full py-2 bg-void-800 hover:bg-void-700 border border-void-600 text-gray-300 rounded text-sm transition-colors mt-auto">Thám Hiểm</button>)}</div>))}</div>)}{activeTab === TabType.LEADERBOARD && (<div className="flex flex-col gap-2 h-full"><h4 className="font-bold text-gold-400 text-center uppercase mb-4 text-xl tracking-widest drop-shadow-md">Bảng Phong Thần</h4><div className="flex-1 overflow-y-auto bg-void-900 rounded border border-void-700 scrollbar-thin scrollbar-thumb-void-600"><table className="w-full text-sm text-left"><thead className="bg-void-800 text-xs text-gray-500 sticky top-0 uppercase tracking-wider z-10"><tr><th className="px-3 py-3 text-center w-12">Hạng</th><th className="px-3 py-3 w-1/4">Danh Xưng</th><th className="px-3 py-3 w-1/3 text-center">Cảnh Giới</th><th className="px-3 py-3 text-right">Lực Chiến</th></tr></thead><tbody className="divide-y divide-void-800 text-xs sm:text-sm">{leaderboard.map((entry) => (<tr key={entry.rank} onClick={() => setInspectingPlayer(entry)} className={`cursor-pointer transition-all hover:bg-void-800 group ${entry.rank <= 3 ? 'bg-void-800/30' : ''}`}><td className="px-3 py-3 text-center">{entry.rank === 1 ? <CanvasIcon type="crown" size={20} color="#facc15" className="mx-auto" /> : entry.rank === 2 ? <CanvasIcon type="medal" size={20} color="#d1d5db" className="mx-auto" /> : entry.rank === 3 ? <CanvasIcon type="medal" size={20} color="#fb923c" className="mx-auto" /> : <span className="font-bold text-gray-600">#{entry.rank}</span>}</td><td className={`px-3 py-3 font-bold group-hover:text-white transition-colors truncate max-w-[100px] ${entry.rank === 1 ? 'text-gold-400' : entry.rank === 2 ? 'text-gray-300' : entry.rank === 3 ? 'text-orange-400' : 'text-gray-500'}`}>{entry.name}</td><td className="px-3 py-3 text-gray-400 font-mono text-center">{entry.realm}</td><td className="px-3 py-3 text-right text-gold-600 font-mono font-bold tracking-tight">{entry.power.toLocaleString()}</td></tr>))}</tbody></table></div></div>)}</div></div></section><section className="w-full lg:w-72 flex flex-col h-[300px] lg:h-auto bg-void-800 border border-void-700 rounded-lg overflow-hidden shrink-0 shadow-xl"><div className="flex border-b border-void-700 bg-void-900 sticky top-0"><button onClick={() => setActiveLogTab('personal')} className={`flex-1 py-3 font-bold text-xs uppercase tracking-wide ${activeLogTab==='personal'?'text-gold-400 bg-void-800 border-b-2 border-gold-400':'text-gray-500 hover:bg-void-800'}`}>Nhật Ký</button><button onClick={() => setActiveLogTab('world')} className={`flex-1 py-3 font-bold text-xs uppercase tracking-wide ${activeLogTab==='world'?'text-gold-400 bg-void-800 border-b-2 border-gold-400':'text-gray-500 hover:bg-void-800'}`}>Thế Giới</button></div><div ref={logsContainerRef} className="flex-1 overflow-y-auto p-3 space-y-1.5 font-mono text-[11px] leading-tight text-gray-400 scrollbar-thin scrollbar-thumb-void-600">{activeLogTab === 'personal' ? (logs.length === 0 ? <div className="text-center italic pt-10 opacity-30">Chưa có hoạt động...</div> : logs.map(l => (<div key={l.id} className={`${l.type === 'success' ? 'text-green-400' : l.type === 'fail' ? 'text-red-400' : l.type === 'info' ? 'text-blue-400' : 'text-gray-400'}`}><span className="opacity-50">[{l.timestamp}]</span> {l.message}</div>))) : (worldChatMessages.map(m => (<div key={m.id}><span className="text-gold-500 font-bold">[{m.sender}]:</span> <span className={m.isSystem ? "text-yellow-200" : "text-gray-300"}>{m.content}</span></div>)))}</div>{activeLogTab === 'world' && (<div className="p-2 bg-void-900 border-t border-void-700 flex gap-2"><input type="text" value={chatInputValue} onChange={(e) => setChatInputValue(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && handleChatSend()} placeholder="Nhập chat..." className="flex-1 bg-void-800 border border-void-600 rounded px-2 py-1 text-xs text-white focus:border-gold-500 focus:outline-none"/><button onClick={handleChatSend} className="bg-void-700 hover:bg-gold-600 hover:text-white border border-void-600 text-gray-400 rounded p-1"><CanvasIcon type="send" size={14} color="#9ca3af"/></button></div>)}</section>{selectedItem && (<ItemDetailModal item={selectedItem} isEquipped={isViewingEquipped} onClose={() => setSelectedItem(null)} onEquip={isReadOnlyItem ? undefined : (item) => { if (item.type !== ItemType.EQUIPMENT || !item.slot) return; const current = player.equipment[item.slot]; setPlayer(prev => { const newInv = prev.inventory.filter(i => i.id !== item.id); if (current) newInv.push({ ...current, count: 1 }); return { ...prev, inventory: newInv, equipment: { ...prev.equipment, [item.slot!]: item } }; }); setSelectedItem(null); savePlayerData(); }} onUnequip={isReadOnlyItem ? undefined : (item) => { setPlayer(prev => ({ ...prev, equipment: { ...prev.equipment, [item.slot!]: undefined }, inventory: [...prev.inventory, { ...item, count: 1 }] })); setSelectedItem(null); savePlayerData(); }} onSell={marketTab === 'sell' && !isReadOnlyItem ? undefined : undefined} onDismantle={undefined} onListMarket={marketTab === 'sell' && !isReadOnlyItem ? handleMarketList : undefined} />)}{showRatesModal && <EnhancementRatesModal onClose={() => setShowRatesModal(false)} />}{previewRealm && (<SecretRealmModal realm={previewRealm} onClose={() => setPreviewRealm(null)} onConfirm={handleConfirmExploration} canEnter={player.majorRealmIdx >= previewRealm.minRealmIdx}/>)}{inspectingPlayer && (<PlayerInspectionModal entry={inspectingPlayer} onClose={() => setInspectingPlayer(null)} onInspectItem={(item) => { setSelectedItem(item); setIsReadOnlyItem(true); }} onSpar={handleSpar}/>)}{combatState && (<CombatModal player={combatState.player} enemy={combatState.enemy} onClose={() => setCombatState(null)}/>)}</main></div>
  );
};
export default App;
